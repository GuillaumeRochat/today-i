+++
date = "2018-01-28T16:29:06+00:00"
draft = true
title = "Elasticsearch"

+++
... learned a bit more about [Elasticsearch](https://www.elastic.co/), more specifically about the index and mappings. It all started from a simple issue where upon querying an execution UUID to get the related logs, we'd get the logs from another execution as well.

My initial though was that we had an issue with our software that was getting the logs from the first query and a specific query and ended up accidentally merging them. However, result was getting straight out of Elasticsearch API, without any alteration from our part. Upon reviewing when it happened, I noticed that it was only when a subset of the UUID matched. Let say we have the UUIDs abc123-baba and def456-baba, that would match because of the "baba". But why?

When we send data to Elasticsearch, it does a [Dynamic Mapping](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-mapping.html), which is rather basic. If it gets a string, it's a text and it goes through the default text analyzer. If it gets a number, it's indexed as a number, etc. The default when receiving a string is to normalize it to build an index. It splits the words on some characters and lower case the string to index it. Which means when we sent the UUID abc123-baba, it indexed it as "abc123" and "baba".

When we query with a [Match](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html) on the text field, it does the same thing, it takes the query it receives, and splits on some characters are normalize the query. So, by asking for UUID "abc123-baba", Elasticsearch was going through the "abc123" and "baba" indexes and returned all results. By default, a match uses the "or" operator. Therefore, we were getting all the results, not just those matching both "abc123" and "baba".

Adding the operator "and" is an option, but as we are working with UUIDs, we actually have unique identifier that we always want to match in totality. A Match is rather resource intensive for such query. The other option is to perform a [Term](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-term-query.html) query instead.